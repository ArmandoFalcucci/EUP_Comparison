---
title: "Comparison EUP_MCA"
author: "Jacopo Gennai"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
```
#Introduction

This is an R Markdown document containing the Rcode and workflow for the "reference_article". This section is dedicated to Multiple Correspondance Analysis

#Datasets

the datasets contain raw data about technological analysis of four Early Upper Palaeolithic assemblages:

-   Ansab AH1 (Jordan)
-   Romanesti-Dumbravita GH3 (Romania)
-   Fumane A1-A2 (Italy)
-   Les Cott√©s 04inf (France)

the assemblages are stratified and radiometrically dated to the period 41-38 ka cal BP.

Datasets are available singularly at the Zenodo repository "insert link or reference". Datasets are divided in "Blanks", debitage products, and "Cores", exhausted blocks of raw material from which debitage products have been struck. The division is due to the different attributes recorded for the two categories.

```{r}
install.packages("FactoMineR")
install.packages("factoextra")
install.packages("ggplot2")
install.packages("dplyr")
install.packages("readxl")
install.packages("writexl")
install.packages("RcmdrMisc")
library(FactoMineR)
library(factoextra)
library(dplyr)
library(ggplot2)
library(readxl)
library(writexl)
library(RcmdrMisc)
```


#Getting the merged datasets and adding two new specifications
first of all we create two Supplementary qualitative variables one that sums up the Site and the Blank.type2 info, and one that sums up Site and the Blank.type1 info 


```{r}
library(readxl)
library(dplyr)
Blanks_Main_merged <- read_excel(file.choose()) #get the Ans_Rom_Fum_CTS_Blanks_merged.xlsx

Blanks_Main_merged_MCA <- Blanks_Main_merged %>%
  mutate(SiteBlank.type2 = Site, .after = Site) %>%
  mutate(SiteBlank.type2 = case_when(
    Site == "AN" & Blank.type2 == "Blade" ~ "AN.Blade",
    Site == "CTS04inf" & Blank.type2 == "Blade" ~ "CTS04inf.Blade",
    Site == "FUM" & Blank.type2 == "Blade" ~ "FUM.Blade",
    Site == "ROM" & Blank.type2 == "Blade" ~ "ROM.Blade",
    Site == "AN" & Blank.type2 == "Bladelet" ~ "AN.bladlt",
    Site == "CTS04inf" & Blank.type2 == "Bladelet" ~ "CTS04inf.bladlt",
    Site == "FUM" & Blank.type2 == "Bladelet" ~ "FUM.bladlt",
    Site == "ROM" & Blank.type2 == "Bladelet" ~ "ROM.bladlt",
    Site == "AN" & Blank.type2 == "Flake" ~ "AN.Flake",
    Site == "CTS" & Blank.type2 == "Flake" ~ "CTS.Flake",
    Site == "FUM" & Blank.type2 == "Flake" ~ "FUM.Flake",
    Site == "ROM" & Blank.type2 == "Flake" ~ "ROM.Flake"
  )) %>%
mutate(SiteLaminar = SiteBlank.type2, .after = SiteBlank.type2) %>%
mutate(SiteLaminar = case_when(
    Site == "AN" & Blank.type1 == "Laminar"  ~ "AN",
    Site == "CTS" & Blank.type1 == "Laminar"  ~ "CTS04inf",
    Site == "FUM" & Blank.type1 == "Laminar" ~ "FUM",
    Site == "ROM" & Blank.type1 == "Laminar" ~ "ROM")) %>%
mutate(
    Length = as.numeric(Length), 
    Width = as.numeric(Width),
    Thickness = as.numeric(Thickness),
    Elongation = as.numeric(Elongation),
    Robustness = as.numeric(Robustness))
    
str(Blanks_Main_merged_MCA)
library(writexl)
write_xlsx(Blanks_Main_merged_MCA, "Ans_Rom_Fum_CTS_Blanks_mergedMCA.xlsx")
```
#New dataframe for testing attributes association with dimensional indexes
```{r}
library(dplyr)
library(RcmdrMisc)
Laminar_Blanks_Merged_MCA <- Blanks_Main_merged_MCA %>%
  filter(Blank.type1 == "Laminar") %>% # Filter the data to include only rows where Blank.Type1 is 'Laminar'
  filter(Robustness != 0) %>%
mutate(Robustness_binned = binVariable(Robustness, bins = 3, method = "natural", labels = c("low", "medium", "high")))  # Bin 'Robustness' into three categories: "low", "medium", and "high"
  
head(Laminar_Blanks_Merged_MCA)
str(Laminar_Blanks_Merged_MCA)
write_xlsx(Laminar_Blanks_Merged_MCA, "Ans_Rom_Fum_CTS_LaminarBlanks_mergedMCA.xlsx")

#numerical values corresponding to the labels
robustness_intervals <- cut(Laminar_Blanks_Merged_MCA$Robustness, breaks = 3)
robustness_levels <- levels(robustness_intervals)

# Print the breakpoints
cat("Robustness Intervals:\n", robustness_levels, "\n\n")

```
#Control Dataframe
```{r}
combinedControl_df <- read_excel(file.choose())

combinedControl_MCA <- combinedControl_df %>%
  filter(Blank.type1=="Laminar")%>%
  mutate(SiteBlank.type2 = Site, .after = Site) %>%
  mutate(SiteBlank.type2 = case_when(
    Site == "AN" & Blank.type2 == "Blade" ~ "AN.Blade",
    Site == "CTS04inf" & Blank.type2 == "Blade" ~ "CTSinf.Blade",
    Site == "FUM" & Blank.type2 == "Blade" ~ "FUM.Blade",
    Site == "ROM" & Blank.type2 == "Blade" ~ "ROM.Blade",
    Site == "AN" & Blank.type2 == "Bladelet" ~ "AN.bladlt",
    Site == "CTS04inf" & Blank.type2 == "Bladelet" ~ "CTSinf.bladlt",
    Site == "FUM" & Blank.type2 == "Bladelet" ~ "FUM.bladlt",
    Site == "ROM" & Blank.type2 == "Bladelet" ~ "ROM.bladlt",
    Technocomplex=="Solu" & Blank.type2 == "Bladelet" ~ "Solu.bladlt",
    Technocomplex=="Solu" & Blank.type2 == "Blade" ~ "Solu.Blade",
  )) %>%
  mutate(TechBlank = SiteBlank.type2, .after = SiteBlank.type2) %>%
mutate(TechBlank = case_when(
    Technocomplex == "S.Ahm" & Blank.type2 == "Blade" ~ "SAhm.Blade",
    Technocomplex == "Proto" & Blank.type2 == "Blade" ~ "Proto.Blade",
    Technocomplex == "S.Ahm" & Blank.type2 == "Bladelet" ~ "SAhm.bladlt",
    Technocomplex == "Proto" & Blank.type2 == "Bladelet" ~ "Proto.bladlt",
    TRUE ~ SiteBlank.type2))%>%
  filter(Robustness != 0) %>%
mutate(Robustness_binned = binVariable(Robustness, bins = 3, method = "natural", labels = c("low", "medium", "high")))# Bin 'Robustness' into three categories: "low", "medium", and "high"

str(combinedControl_MCA)
library(writexl)
write_xlsx(combinedControl_MCA, "Control_Blanks_MCA.xlsx")
```

#MCA

first of all we are checking internal variablity within sites
#Platform

##AN
```{r}


# Select relevant columns and remove missing values
platform_maintenanceAN <- Laminar_Blanks_Merged_MCA %>%
  filter(Preservation != "Mesiodistal") %>% #only blanks with a Proximal part
  filter(!Platform %in% c("ND", NA)) %>% #removing blanks without clear info
  filter(!Abrasion %in% c(NA, "ND")) %>% #removing blanks without clear info
  filter(Site == "AN") %>% #getting only Ansab
  select(SiteBlank.type2, Abrasion, Platform, Robustness_binned) %>%
  na.omit()
  
summary(platform_maintenanceAN)

# Run MCA
res.mca_PlatformAN <- MCA(platform_maintenanceAN, graph = FALSE, quali.sup =1, method = "Burt") # SiteBlank.type1 is not part of the active variables used to compute the MCA but is considered as supplementary information. The MCA analysis is performed based on the active variables in platform_maintenanceAN, and the supplementary variables are used to provide additional information or context to the analysis. Their coordinates are predicted using only the information provided by the performed multiple correspondence analysis on active variables/individuals.

print(res.mca_PlatformAN)
fviz_screeplot(res.mca_PlatformAN, addlabels = TRUE, ylim = c(0, 45)) #To visualize the percentages of inertia explained by each MCA dimensions. Dim1 and Dim2 explain 56.986% of the variance
summary(res.mca_PlatformAN)

MCA_PlatformAN_plot <- fviz_mca_var(
  res.mca_PlatformAN,
  col.var = "contrib",
  label = "all",
  invisible = "none",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  max.overlaps=Inf,
  ggtheme = theme_classic()
)
MCA_PlatformAN_plot

ggsave("MCAPlatformAN.tiff", plot = MCA_PlatformAN_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("MCAPlatformAN.png", plot = MCA_PlatformAN_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)    

#variance explained by each Dimension
res.mca_PlatformAN$eig
fviz_screeplot(res.mca_PlatformAN, addlabels = TRUE, ylim = c(0, 45)) 
#contribution to Dim 1 and Dim 2
fviz_contrib(res.mca_PlatformAN, choice = "var", axes = 1, top = 15) #contribution to Dim 1. above the threshold are No, Other, Punctiform 

fviz_contrib(res.mca_PlatformAN, choice = "var", axes = 2, top = 15) #contribution to Dim 2. above the threshold is only Plain, Punctiform, Linear

#check and visualise association of variables to Dim 1
cos2_values_dim1 <- res.mca_PlatformAN$var$cos2[, 1]

threshold_percentile <- quantile(cos2_values_dim1, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_PlatformAN, choice = "var", axes = 1)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#check and visualise association of variables to Dim 2
cos2_values_dim2 <- res.mca_PlatformAN$var$cos2[, 2]
threshold_percentile <- quantile(cos2_values_dim2, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_PlatformAN, choice = "var", axes = 2)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#association of supplementary categories
cos2_values_supdim1 <- res.mca_PlatformAN$quali.sup$cos2[, 1]

threshold_percentilesup1 <- quantile(cos2_values_supdim1, 0.75)

print(threshold_percentilesup1)

filtered_cos2_supdim1 <- cos2_values_supdim1[cos2_values_supdim1 > threshold_percentilesup1]
print(filtered_cos2_supdim1)

cos2_values_supdim2 <- res.mca_PlatformAN$quali.sup$cos2[, 2]

threshold_percentilesup2 <- quantile(cos2_values_supdim2, 0.75)

print(threshold_percentilesup2)

filtered_cos2_supdim2 <- cos2_values_supdim2[cos2_values_supdim2 > threshold_percentilesup2]
print(filtered_cos2_supdim2)

```
##ROM
```{r}

# Select relevant columns and remove missing values
platform_maintenanceROM <- Laminar_Blanks_Merged_MCA %>%
  filter(Preservation != "Mesiodistal") %>% #only blanks with a Proximal part
  filter(!Platform %in% c("ND", NA)) %>% #removing blanks without clear info
  filter(!Abrasion %in% c(NA, "ND")) %>% #removing blanks without clear info
  filter(Site == "ROM") %>% #getting only Ansab
  select(SiteBlank.type2, Abrasion, Platform, Robustness_binned) %>%
  na.omit()
  
summary(platform_maintenanceROM)

# Run MCA
res.mca_PlatformROM <- MCA(platform_maintenanceROM, graph = FALSE, quali.sup =1, method = "Burt") # SiteBlank.type1 is not part of the active variables used to compute the MCA but is considered as supplementary information. The MCA analysis is performed based on the active variables in platform_maintenanceROM, and the supplementary variables are used to provide additional information or context to the analysis. Their coordinates are predicted using only the information provided by the performed multiple correspondence analysis on active variables/individuals.

print(res.mca_PlatformROM)
summary(res.mca_PlatformROM)

MCA_PlatformROM_plot <- fviz_mca_var(
  res.mca_PlatformROM,
  col.var = "contrib",
  label = "all",
  invisible = "none",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  max.overlaps=Inf,
  ggtheme = theme_classic()
)
MCA_PlatformROM_plot

ggsave("MCAPlatformROM.tiff", plot = MCA_PlatformROM_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("MCAPlatformROM.png", plot = MCA_PlatformROM_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300) 

#variance explained by each Dimension
res.mca_PlatformROM$eig
fviz_screeplot(res.mca_PlatformROM, addlabels = TRUE, ylim = c(0, 45)) 
#contribution to Dim 1 and Dim 2
fviz_contrib(res.mca_PlatformROM, choice = "var", axes = 1, top = 15) #contribution to Dim 1. above the threshold are No, Other, Punctiform 

fviz_contrib(res.mca_PlatformROM, choice = "var", axes = 2, top = 15) #contribution to Dim 2. above the threshold is only Plain, Punctiform, Linear

#check and visualise association of variables to Dim 1
cos2_values_dim1 <- res.mca_PlatformROM$var$cos2[, 1]

threshold_percentile <- quantile(cos2_values_dim1, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_PlatformROM, choice = "var", axes = 1)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#check and visualise association of variables to Dim 2
cos2_values_dim2 <- res.mca_PlatformROM$var$cos2[, 2]
threshold_percentile <- quantile(cos2_values_dim2, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_PlatformROM, choice = "var", axes = 2)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#association of supplementary categories
cos2_values_supdim1 <- res.mca_PlatformROM$quali.sup$cos2[, 1]

threshold_percentilesup1 <- quantile(cos2_values_supdim1, 0.75)

print(threshold_percentilesup1)

filtered_cos2_supdim1 <- cos2_values_supdim1[cos2_values_supdim1 > threshold_percentilesup1]
print(filtered_cos2_supdim1)

cos2_values_supdim2 <- res.mca_PlatformROM$quali.sup$cos2[, 2]

threshold_percentilesup2 <- quantile(cos2_values_supdim2, 0.75)

print(threshold_percentilesup2)

filtered_cos2_supdim2 <- cos2_values_supdim2[cos2_values_supdim2 > threshold_percentilesup2]
print(filtered_cos2_supdim2)
```

##FUM
```{r}
library(FactoMineR)
library(factoextra)
library(dplyr)
library(ggplot2)

# Select relevant columns and remove missing values
platform_maintenanceFUM <- Laminar_Blanks_Merged_MCA %>%
  filter(Preservation != "Mesiodistal") %>% #only blanks with a Proximal part
  filter(!Platform %in% c("ND", NA)) %>% #removing blanks without clear info
  filter(!Abrasion %in% c(NA, "ND")) %>% #removing blanks without clear info
  filter(Site == "FUM") %>% #getting only Ansab
  select(SiteBlank.type2, Abrasion, Platform, Robustness_binned) %>%
  na.omit()
  
summary(platform_maintenanceFUM)

# Run MCA
res.mca_PlatformFUM <- MCA(platform_maintenanceFUM, graph = FALSE, method = "Burt", quali.sup =1) # SiteBlank.type1 is not part of the active variables used to compute the MCA but is considered as supplementary information. The MCA analysis is performed based on the active variables in platform_maintenanceFUM, and the supplementary variables are used to provide additional information or context to the analysis. Their coordinates are predicted using only the information provided by the performed multiple correspondence analysis on active variables/individuals.

print(res.mca_PlatformFUM)

MCA_PlatformFUM_plot <- fviz_mca_var(
  res.mca_PlatformFUM,
  col.var = "contrib",
  label = "all",
  invisible = "none",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  max.overlaps=Inf,
  ggtheme = theme_classic()
)
MCA_PlatformFUM_plot

ggsave("MCAPlatformFUM.tiff", plot = MCA_PlatformFUM_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("MCAPlatformFUM.png", plot = MCA_PlatformFUM_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)

#variance explained by each Dimension
res.mca_PlatformFUM$eig
fviz_screeplot(res.mca_PlatformFUM, addlabels = TRUE, ylim = c(0, 45)) 
#contribution to Dim 1 and Dim 2
fviz_contrib(res.mca_PlatformFUM, choice = "var", axes = 1, top = 15) #contribution to Dim 1. above the threshold are No, Other, Punctiform 

fviz_contrib(res.mca_PlatformFUM, choice = "var", axes = 2, top = 15) #contribution to Dim 2. above the threshold is only Plain, Punctiform, Linear

#check and visualise association of variables to Dim 1
cos2_values_dim1 <- res.mca_PlatformFUM$var$cos2[, 1]

threshold_percentile <- quantile(cos2_values_dim1, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_PlatformFUM, choice = "var", axes = 1)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#check and visualise association of variables to Dim 2
cos2_values_dim2 <- res.mca_PlatformFUM$var$cos2[, 2]
threshold_percentile <- quantile(cos2_values_dim2, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_PlatformFUM, choice = "var", axes = 2)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#association of supplementary categories
cos2_values_supdim1 <- res.mca_PlatformFUM$quali.sup$cos2[, 1]

threshold_percentilesup1 <- quantile(cos2_values_supdim1, 0.75)

print(threshold_percentilesup1)

filtered_cos2_supdim1 <- cos2_values_supdim1[cos2_values_supdim1 > threshold_percentilesup1]
print(filtered_cos2_supdim1)

cos2_values_supdim2 <- res.mca_PlatformFUM$quali.sup$cos2[, 2]

threshold_percentilesup2 <- quantile(cos2_values_supdim2, 0.75)

print(threshold_percentilesup2)

filtered_cos2_supdim2 <- cos2_values_supdim2[cos2_values_supdim2 > threshold_percentilesup2]
print(filtered_cos2_supdim2)
```


##CTS
```{r}

# Select relevant columns and remove missing values
platform_maintenanceCTS <- Laminar_Blanks_Merged_MCA %>%
  filter(Preservation != "Mesiodistal") %>% #only blanks with a Proximal part
  filter(!Platform %in% c("ND", NA)) %>% #removing blanks without clear info
  filter(!Abrasion %in% c(NA, "ND")) %>% #removing blanks without clear info
  filter(Site == "CTS04inf") %>% #getting only CTS
  select(SiteBlank.type2, Abrasion, Platform, Robustness_binned) %>%
  na.omit()
  
summary(platform_maintenanceCTS)

# Run MCA
res.mca_PlatformCTS <- MCA(platform_maintenanceCTS, graph = FALSE, quali.sup =1, method = "Burt") # SiteBlank.type1 is not part of the active variables used to compute the MCA but is considered as supplementary information. The MCA analysis is performed based on the active variables in platform_maintenanceCTS, and the supplementary variables are used to provide additional information or context to the analysis. Their coordinates are predicted using only the information provided by the performed multiple correspondence analysis on active variables/individuals.

print(res.mca_PlatformCTS)

MCA_PlatformCTS_plot <- fviz_mca_var(
  res.mca_PlatformCTS,
  col.var = "contrib",
  label = "all",
  invisible = "none",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  max.overlaps=Inf,
  ggtheme = theme_classic()
)
MCA_PlatformCTS_plot


ggsave("MCAPlatformCTS.tiff", plot = MCA_PlatformCTS_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("MCAPlatformCTS.png", plot = MCA_PlatformCTS_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)  

#variance explained by each Dimension
res.mca_PlatformCTS$eig
fviz_screeplot(res.mca_PlatformCTS, addlabels = TRUE, ylim = c(0, 45)) 
#contribution to Dim 1 and Dim 2
fviz_contrib(res.mca_PlatformCTS, choice = "var", axes = 1, top = 15) #contribution to Dim 1. above the threshold are No, Other, Punctiform 

fviz_contrib(res.mca_PlatformCTS, choice = "var", axes = 2, top = 15) #contribution to Dim 2. above the threshold is only Plain, Punctiform, Linear

#check and visualise association of variables to Dim 1
cos2_values_dim1 <- res.mca_PlatformCTS$var$cos2[, 1]

threshold_percentile <- quantile(cos2_values_dim1, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_PlatformCTS, choice = "var", axes = 1)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#check and visualise association of variables to Dim 2
cos2_values_dim2 <- res.mca_PlatformCTS$var$cos2[, 2]
threshold_percentile <- quantile(cos2_values_dim2, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_PlatformCTS, choice = "var", axes = 2)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#association of supplementary categories
cos2_values_supdim1 <- res.mca_PlatformCTS$quali.sup$cos2[, 1]

threshold_percentilesup1 <- quantile(cos2_values_supdim1, 0.75)

print(threshold_percentilesup1)

filtered_cos2_supdim1 <- cos2_values_supdim1[cos2_values_supdim1 > threshold_percentilesup1]
print(filtered_cos2_supdim1)

cos2_values_supdim2 <- res.mca_PlatformCTS$quali.sup$cos2[, 2]

threshold_percentilesup2 <- quantile(cos2_values_supdim2, 0.75)

print(threshold_percentilesup2)

filtered_cos2_supdim2 <- cos2_values_supdim2[cos2_values_supdim2 > threshold_percentilesup2]
print(filtered_cos2_supdim2)
```
##ALL SITES

```{r}

# Select relevant columns and remove missing values
platform_maintenanceALL2 <- Laminar_Blanks_Merged_MCA %>%
  filter(Preservation != "Mesiodistal") %>% #only blanks with a Proximal part
  filter(!Platform %in% c("ND", NA)) %>% #removing blanks without clear info
  filter(!Abrasion %in% c(NA, "ND")) %>% #removing blanks without clear info
  select(SiteBlank.type2, Blank.type2, Abrasion, Platform, Robustness_binned) %>%
  na.omit()
  
summary(platform_maintenanceALL2)

# Run MCA
res.mca_PlatformALL2 <- MCA(platform_maintenanceALL2, graph = FALSE, quali.sup =1:2, method = "Burt") # SiteBlank.type2, Blank.type2 supplementary categories

#biplot MCA

MCA_PlatformALL2_plot <- fviz_mca_var(
  res.mca_PlatformALL2,
  col.var = "contrib",
  label = "all",
  invisible = "none",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  max.overlaps=Inf,
  ggtheme = theme_classic()
)
MCA_PlatformALL2_plot

ggsave("MCAPlatformALL.tiff", plot = MCA_PlatformALL2_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("MCAPlatformALL.png", plot = MCA_PlatformALL2_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)    

#variance explained by each Dimension
res.mca_PlatformALL2$eig
fviz_screeplot(res.mca_PlatformALL2, addlabels = TRUE, ylim = c(0, 45)) 
#contribution to Dim 1 and Dim 2
fviz_contrib(res.mca_PlatformALL2, choice = "var", axes = 1, top = 15) #contribution to Dim 1.

fviz_contrib(res.mca_PlatformALL2, choice = "var", axes = 2, top = 15) #contribution to Dim 2. 

#check and visualise association of variables to Dim 1
cos2_values_dim1 <- res.mca_PlatformALL2$var$cos2[, 1]

threshold_percentile <- quantile(cos2_values_dim1, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_PlatformALL2, choice = "var", axes = 1)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#check and visualise association of variables to Dim 2
cos2_values_dim2 <- res.mca_PlatformALL2$var$cos2[, 2]
threshold_percentile <- quantile(cos2_values_dim2, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_PlatformALL2, choice = "var", axes = 2)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#association of supplementary categories
cos2_values_supdim1 <- res.mca_PlatformALL2$quali.sup$cos2[, 1]

threshold_percentilesup1 <- quantile(cos2_values_supdim1, 0.75)

print(threshold_percentilesup1)

filtered_cos2_supdim1 <- cos2_values_supdim1[cos2_values_supdim1 > threshold_percentilesup1]
print(filtered_cos2_supdim1)

cos2_values_supdim2 <- res.mca_PlatformALL2$quali.sup$cos2[, 2]

threshold_percentilesup2 <- quantile(cos2_values_supdim2, 0.75)

print(threshold_percentilesup2)

filtered_cos2_supdim2 <- cos2_values_supdim2[cos2_values_supdim2 > threshold_percentilesup2]
print(filtered_cos2_supdim2)


```
###correlation
```{r}

library(factoextra)

coord_var1 <- as.data.frame(res.mca_PlatformALL2$var$coord[, 1:2])

coord_sup1 <- as.data.frame(res.mca_PlatformALL2$quali.sup$coord[, 1:2])

# Subset only rows where the categories are "Blade" or "Bladelet"
coord_sup1.2 <- coord_sup1 %>% filter(row.names(coord_sup1) %in% c("Blade", "Bladelet")) 
coord_sup1.3 <- coord_sup1 %>% filter(!(row.names(coord_sup1) %in% c("Blade", "Bladelet")))

# Print the subsetted dataframe
print(coord_sup1.2)

coord_combined1 <- rbind(coord_var1, coord_sup1)
coord_combined1.2 <-rbind(coord_var1, coord_sup1.2)
coord_combined1.3 <-rbind(coord_var1, coord_sup1.3)

# Calculate distance matrix and visualize using VAT
data.cor1 <- get_dist(coord_var1, method = "euclidean")
print(data.cor1)
# Export matrix in excel
data.cor1_df <- as.data.frame(as.matrix(data.cor1))
write_xlsx(data.cor1_df, "CorrelationAttributesPlatform1.xlsx")

#heatmap
corPlat1 <- fviz_dist(dist.obj = data.cor1, 
                     order = TRUE, 
                     show_labels = TRUE) 
corPlat1


ggsave("CORRPlatformALL.tiff", plot = corPlat1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRPlatformALL.png", plot = corPlat1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)   

data.cor2 <- get_dist(coord_combined1.2, method = "euclidean")
data.cor2_df <- as.data.frame(as.matrix(data.cor2))
write_xlsx(data.cor2_df, "CorrelationAttributesPlatform2.xlsx")

#heatmap
corPlat2 <- fviz_dist(dist.obj = data.cor2, 
                     order = TRUE, 
                     show_labels = TRUE) 
corPlat2

ggsave("CORRPlatformALL_withquali.tiff", plot = corPlat2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRPlatformALL_withquali.png", plot = corPlat2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)

data.cor3 <- get_dist(coord_combined1.3, method = "euclidean")
print(data.cor3)

data.cor3_df <- as.data.frame(as.matrix(data.cor3))
write_xlsx(data.cor3_df, "CorrelationAttributesPlatform3.xlsx")


#heatmap
corPlat3 <- fviz_dist(dist.obj = data.cor3, 
                     order = TRUE, 
                     show_labels = TRUE) 
corPlat3

ggsave("CORRPlatformALL_withquali_2.tiff", plot = corPlat3, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRPlatformALL_withquali_2.png", plot = corPlat3, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
```


##CONTROL
```{r}

# Select relevant columns and remove missing values
platform_maintenance_CONTROL <- combinedControl_MCA %>%
  filter(Blank.type1 != "Flake") %>% #check only laminar
  filter(!Platform %in% c("ND", NA, "Other", "Crushed")) %>% #removing blanks without clear info
  select(Technocomplex, SiteBlank.type2, Platform, Robustness_binned) %>%
  na.omit()
  
summary(platform_maintenance_CONTROL)

# Run MCA
res.mca_PlatformCONTROL <- MCA(platform_maintenance_CONTROL, graph = FALSE, quali.sup =1:2, method = "Burt") # SiteBlank.type1 is not part of the active variables used to compute the MCA but is considered as supplementary information. The MCA analysis is performed based on the active variables in platform_maintenanceALL2, and the supplementary variables are used to provide additional information or context to the analysis. Their coordinates are predicted using only the information provided by the performed multiple correspondence analysis on active variables/individuals.

MCA_PlatformCONTROL_plot <- fviz_mca_var(
  res.mca_PlatformCONTROL,
  col.var = "contrib",
  label = "all",
  invisible = "none",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  max.overlaps= 20,
  ggtheme = theme_classic()
)
MCA_PlatformCONTROL_plot

ggsave("MCAPlatformCONTROL.tiff", plot = MCA_PlatformCONTROL_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("MCAPlatformCONTROL.png", plot = MCA_PlatformCONTROL_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300) 

#variance explained by each Dimension
res.mca_PlatformCONTROL$eig
fviz_screeplot(res.mca_PlatformCONTROL, addlabels = TRUE, ylim = c(0, 45)) 
#contribution to Dim 1 and Dim 2
fviz_contrib(res.mca_PlatformCONTROL, choice = "var", axes = 1, top = 15) #contribution to Dim 1. above the threshold are No, Other, Punctiform 

fviz_contrib(res.mca_PlatformCONTROL, choice = "var", axes = 2, top = 15) #contribution to Dim 2. above the threshold is only Plain, Punctiform, Linear

#check and visualise association of variables to Dim 1
cos2_values_dim1 <- res.mca_PlatformCONTROL$var$cos2[, 1]

threshold_percentile <- quantile(cos2_values_dim1, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_PlatformCONTROL, choice = "var", axes = 1)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#check and visualise association of variables to Dim 2
cos2_values_dim2 <- res.mca_PlatformCONTROL$var$cos2[, 2]
threshold_percentile <- quantile(cos2_values_dim2, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_PlatformCONTROL, choice = "var", axes = 2)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#association of supplementary categories
cos2_values_supdim1 <- res.mca_PlatformCONTROL$quali.sup$cos2[, 1]

threshold_percentilesup1 <- quantile(cos2_values_supdim1, 0.75)

print(threshold_percentilesup1)

filtered_cos2_supdim1 <- cos2_values_supdim1[cos2_values_supdim1 > threshold_percentilesup1]
print(filtered_cos2_supdim1)

cos2_values_supdim2 <- res.mca_PlatformCONTROL$quali.sup$cos2[, 2]

threshold_percentilesup2 <- quantile(cos2_values_supdim2, 0.75)

print(threshold_percentilesup2)

filtered_cos2_supdim2 <- cos2_values_supdim2[cos2_values_supdim2 > threshold_percentilesup2]
print(filtered_cos2_supdim2)


```
###correlation
```{r}

library(factoextra)

coord_var2 <- as.data.frame(res.mca_PlatformCONTROL$var$coord[, 1:2])

coord_sup2 <- as.data.frame(res.mca_PlatformCONTROL$quali.sup$coord[, 1:2])

# Combine both for distance calculation
coord_sup2.2 <- coord_sup2 %>% filter(row.names(coord_sup2) %in% c("Proto", "S.Ahm", "Solu")) 
coord_sup2.3 <- coord_sup2 %>% filter(!(row.names(coord_sup2) %in% c("Proto", "S.Ahm", "Solu")))


coord_combined2 <- rbind(coord_var2, coord_sup2)
coord_combined2.2 <-rbind(coord_var2, coord_sup2.2)
coord_combined2.3 <-rbind(coord_var2, coord_sup2.3)


# Calculate the distance matrix using euclidean correlation distance
data.cor4 <- get_dist(coord_var2, method = "euclidean")
data.cor4_df <- as.data.frame(as.matrix(data.cor4))
write_xlsx(data.cor4_df, "CorrelationAttributesPlatformCONTROL1.xlsx")


#heatmap
corPlat3 <- fviz_dist(dist.obj = data.cor4, 
                     order = TRUE, 
                     show_labels = TRUE)
corPlat3


ggsave("CORRPlatformCONTROL.tiff", plot = corPlat3, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRPlatformCONTROL.png", plot = corPlat3, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)

data.cor5 <- get_dist(coord_combined2.2, method = "euclidean")
data.cor5_df <- as.data.frame(as.matrix(data.cor5))
write_xlsx(data.cor5_df, "CorrelationAttributesPlatformCONTROL2.xlsx")

#heatmap
corPlat4 <- fviz_dist(dist.obj = data.cor5, 
                     order = TRUE, 
                     show_labels = TRUE)
corPlat4


ggsave("CORRPlatformCONTROL_withquali.tiff", plot = corPlat4, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRPlatformCONTROL_withquali.png", plot = corPlat4, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)

data.cor6 <- get_dist(coord_combined2.3, method = "euclidean")
data.cor6_df <- as.data.frame(as.matrix(data.cor6))
write_xlsx(data.cor6_df, "CorrelationAttributesPlatformCONTROL3.xlsx")


#heatmap
corPlat5 <- fviz_dist(dist.obj = data.cor6, 
                     order = TRUE, 
                     show_labels = TRUE)
corPlat5


ggsave("CORRPlatformCONTROL_withquali_2.tiff", plot = corPlat5, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRPlatformCONTROL_withquali_2.png", plot = corPlat5, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)

```


#Convexity shaping
##AN
```{r}
library(FactoMineR)
library(factoextra)
library(dplyr)
library(ggplot2)



# Select relevant columns and remove missing values
convexity_maintenanceAN <- Blanks_Main_merged_MCA %>%
  filter(!Axiality %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Symmetry %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Outline.morphology %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Profile %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Cross.section %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Torsion %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Distal.end.morpho %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(Site == "AN") %>% #only Ansab
  select(SiteBlank.type2, Axiality, Outline.morphology, Symmetry, Cross.section, Profile, Torsion, Distal.end.morpho) %>%
  na.omit()

summary(convexity_maintenanceAN)
# Run MCA
res.mca_ConvexityAN <- MCA(convexity_maintenanceAN, graph = FALSE, quali.sup =1, method = "Burt") # SiteBlank.type1 is not part of the active variables used to compute the MCA but is considered as supplementary information. The MCA analysis is performed based on the active variables in convexity_maintenanceAN, and the supplementary variables are used to provide additional information or context to the analysis. Their coordinates are predicted using only the information provided by the performed multiple correspondence analysis on active variables/individuals.

MCA_ConvexityAN_plot <- fviz_mca_var(
  res.mca_ConvexityAN,
  col.var = "contrib",
  label = "all",
  invisible = "none",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  max.overlaps=Inf,
  ggtheme = theme_classic()
)
MCA_ConvexityAN_plot


ggsave("MCAConvexityAN.tiff", plot = MCA_ConvexityAN_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("MCAConvexityAN.png", plot = MCA_ConvexityAN_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)   
#variance explained by each Dimension
res.mca_ConvexityAN$eig
fviz_screeplot(res.mca_ConvexityAN, addlabels = TRUE, ylim = c(0, 45)) 
#contribution to Dim 1 and Dim 2
fviz_contrib(res.mca_ConvexityAN, choice = "var", axes = 1, top = 15) #contribution to Dim 1. above the threshold are No, Other, Punctiform 

fviz_contrib(res.mca_ConvexityAN, choice = "var", axes = 2, top = 15) #contribution to Dim 2. above the threshold is only Plain, Punctiform, Linear

#check and visualise association of variables to Dim 1
cos2_values_dim1 <- res.mca_ConvexityAN$var$cos2[, 1]

threshold_percentile <- quantile(cos2_values_dim1, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_ConvexityAN, choice = "var", axes = 1)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#check and visualise association of variables to Dim 2
cos2_values_dim2 <- res.mca_ConvexityAN$var$cos2[, 2]
threshold_percentile <- quantile(cos2_values_dim2, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_ConvexityAN, choice = "var", axes = 2)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#association of supplementary categories
cos2_values_supdim1 <- res.mca_ConvexityAN$quali.sup$cos2[, 1]

threshold_percentilesup1 <- quantile(cos2_values_supdim1, 0.75)

print(threshold_percentilesup1)

filtered_cos2_supdim1 <- cos2_values_supdim1[cos2_values_supdim1 > threshold_percentilesup1]
print(filtered_cos2_supdim1)

cos2_values_supdim2 <- res.mca_ConvexityAN$quali.sup$cos2[, 2]

threshold_percentilesup2 <- quantile(cos2_values_supdim2, 0.75)

print(threshold_percentilesup2)

filtered_cos2_supdim2 <- cos2_values_supdim2[cos2_values_supdim2 > threshold_percentilesup2]
print(filtered_cos2_supdim2)
```
###correlation
```{r}
library(factoextra)

coord_varAN3 <- as.data.frame(res.mca_ConvexityAN$var$coord[, 1:2])

coord_supAN3 <- as.data.frame(res.mca_ConvexityAN$quali.sup$coord[, 1:2])

# Subset only rows where the categories are "Blade" or "Bladelet"
coord_supAN3.2 <- coord_supAN3 %>% filter(!(row.names(coord_supAN3) %in% c("Blade", "Bladelet")))


coord_combinedAN3 <- rbind(coord_varAN3, coord_supAN3)
coord_combinedAN3.2 <-rbind(coord_varAN3, coord_supAN3.2)


# Calculate distance matrix and visualize using VAT
data.corAN7 <- get_dist(coord_varAN3, method = "euclidean")
print(data.corAN7)
data.corAN7_df <- as.data.frame(as.matrix(data.corAN7))
write_xlsx(data.corAN7_df, "CorrelationAttributesConvexityAN1.xlsx")


#heatmap
corConvAN1 <- fviz_dist(dist.obj = data.corAN7, 
                     order = TRUE, 
                     show_labels = TRUE)
corConvAN1

ggsave("CORRConvexityAN.tiff", plot = corConvAN1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityAN.png", plot = corConvAN1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)   

data.corAN8 <- get_dist(coord_combinedAN3.2, method = "euclidean")
data.corAN8_df <- as.data.frame(as.matrix(data.corAN8))
write_xlsx(data.corAN8_df, "CorrelationAttributesConvexityAN2.xlsx")

#heatmap
corConvAN2 <- fviz_dist(dist.obj = data.corAN8, 
                     order = TRUE, 
                     show_labels = TRUE)
corConvAN2

ggsave("CORRConvexityAN_withquali.tiff", plot = corConvAN2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityLL_withquali.png", plot = corConvAN2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
```

##ROM
```{r}
library(FactoMineR)
library(factoextra)
library(dplyr)
library(ggplot2)



# Select relevant columns and remove missing values
convexity_maintenanceROM <- Blanks_Main_merged_MCA %>%
  filter(Blank.type1 != "Flake") %>% #check only laminar
  filter(!Axiality %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Symmetry %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Outline.morphology %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Profile %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Cross.section %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Torsion %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Distal.end.morpho %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(Site == "ROM") %>% #only ARomanesti
  select(SiteBlank.type2, Axiality, Outline.morphology, Symmetry, Cross.section, Profile, Torsion, Distal.end.morpho) %>%
  na.omit()

summary(convexity_maintenanceROM)
# Run MCA
res.mca_ConvexityROM <- MCA(convexity_maintenanceROM, graph = FALSE, quali.sup =1, method = "Burt") # SiteBlank.type1 is not part of the active variables used to compute the MCA but is considered as supplementary information. The MCA analysis is performed based on the active variables in convexity_maintenanceROM, and the supplementary variables are used to provide additional information or context to the analysis. Their coordinates are predicted using only the information provided by the performed multiple correspondence analysis on active variables/individuals.

MCA_ConvexityROM_plot <- fviz_mca_var(
  res.mca_ConvexityROM,
  col.var = "contrib",
  label = "all",
  invisible = "none",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  max.overlaps=Inf,
  ggtheme = theme_classic()
)
MCA_ConvexityROM_plot


ggsave("MCAConvexityROM.tiff", plot = MCA_ConvexityROM_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("MCAConvexityROM.png", plot = MCA_ConvexityROM_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)    

#variance explained by each Dimension
res.mca_ConvexityROM$eig
fviz_screeplot(res.mca_ConvexityROM, addlabels = TRUE, ylim = c(0, 45)) 
#contribution to Dim 1 and Dim 2
fviz_contrib(res.mca_ConvexityROM, choice = "var", axes = 1, top = 15) #contribution to Dim 1. above the threshold are No, Other, Punctiform 

fviz_contrib(res.mca_ConvexityROM, choice = "var", axes = 2, top = 15) #contribution to Dim 2. above the threshold is only Plain, Punctiform, Linear

#check and visualise association of variables to Dim 1
cos2_values_dim1 <- res.mca_ConvexityROM$var$cos2[, 1]

threshold_percentile <- quantile(cos2_values_dim1, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_ConvexityROM, choice = "var", axes = 1)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#check and visualise association of variables to Dim 2
cos2_values_dim2 <- res.mca_ConvexityROM$var$cos2[, 2]
threshold_percentile <- quantile(cos2_values_dim2, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_ConvexityROM, choice = "var", axes = 2)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#association of supplementary categories
cos2_values_supdim1 <- res.mca_ConvexityROM$quali.sup$cos2[, 1]

threshold_percentilesup1 <- quantile(cos2_values_supdim1, 0.75)

print(threshold_percentilesup1)

filtered_cos2_supdim1 <- cos2_values_supdim1[cos2_values_supdim1 > threshold_percentilesup1]
print(filtered_cos2_supdim1)

cos2_values_supdim2 <- res.mca_ConvexityROM$quali.sup$cos2[, 2]

threshold_percentilesup2 <- quantile(cos2_values_supdim2, 0.75)

print(threshold_percentilesup2)

filtered_cos2_supdim2 <- cos2_values_supdim2[cos2_values_supdim2 > threshold_percentilesup2]
print(filtered_cos2_supdim2)


```
###correlation
```{r}
library(factoextra)

coord_varROM3 <- as.data.frame(res.mca_ConvexityROM$var$coord[, 1:2])

coord_supROM3 <- as.data.frame(res.mca_ConvexityROM$quali.sup$coord[, 1:2])

# Subset only rows where the categories are "Blade" or "Bladelet"
coord_supROM3.2 <- coord_supROM3 %>% filter(!row.names(coord_supROM3) %in% c("Blade", "Bladelet")) 


coord_combinedROM3 <- rbind(coord_varROM3, coord_supROM3)
coord_combinedROM3.2 <-rbind(coord_varROM3, coord_supROM3.2)

# Calculate distROMce matrix ROMd visualize using VAT
data.corROM7 <- get_dist(coord_varROM3, method = "euclidean")
print(data.corROM7)
data.corROM7_df <- as.data.frame(as.matrix(data.corROM7))
write_xlsx(data.corROM7_df, "CorrelationAttributesConvexityROM1.xlsx")


#heatmap
corConvROM1 <- fviz_dist(dist.obj = data.corROM7, 
                     order = TRUE, 
                     show_labels = TRUE)
corConvROM1

ggsave("CORRConvexityROM.tiff", plot = corConvROM1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityROM.png", plot = corConvROM1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)   

data.corROM8 <- get_dist(coord_combinedROM3.2, method = "euclidean")
data.corROM8_df <- as.data.frame(as.matrix(data.corROM8))
write_xlsx(data.corROM8_df, "CorrelationAttributesConvexityROM2.xlsx")

#heatmap
corConvROM2 <- fviz_dist(dist.obj = data.corROM8, 
                     order = TRUE, 
                     show_labels = TRUE)
corConvROM2

ggsave("CORRConvexityROM_withquali.tiff", plot = corConvROM2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityLL_withquali.png", plot = corConvROM2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
```


##FUM
```{r}
library(FactoMineR)
library(factoextra)
library(dplyr)
library(ggplot2)



# Select relevant columns and remove missing values
convexity_maintenanceFUM <- Blanks_Main_merged_MCA %>%
  filter(Blank.type1 != "Flake") %>% #check only laminar
  filter(!Axiality %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Symmetry %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Outline.morphology %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Profile %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Cross.section %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Torsion %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Distal.end.morpho %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(Site == "FUM") %>% #only Fumane
  select(SiteBlank.type2, Axiality, Outline.morphology, Symmetry, Cross.section, Profile, Torsion, Distal.end.morpho) %>%
  na.omit()

summary(convexity_maintenanceFUM)
# Run MCA
res.mca_ConvexityFUM <- MCA(convexity_maintenanceFUM, graph = FALSE, quali.sup =1, method = "Burt") # SiteBlank.type1 is not part of the active variables used to compute the MCA but is considered as supplementary information. The MCA analysis is performed based on the active variables in convexity_maintenanceFUM, and the supplementary variables are used to provide additional information or context to the analysis. Their coordinates are predicted using only the information provided by the performed multiple correspondence analysis on active variables/individuals.


MCA_ConvexityFUM_plot <- fviz_mca_var(
  res.mca_ConvexityFUM,
  col.var = "contrib",
  label = "all",
  invisible = "none",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  max.overlaps=Inf,
  ggtheme = theme_classic()
)
MCA_ConvexityFUM_plot



ggsave("MCAConvexityFUM.tiff", plot = MCA_ConvexityFUM_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("MCAConvexityFUM.png", plot = MCA_ConvexityFUM_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300) 

#variance explained by each Dimension
res.mca_ConvexityfFUM$eig
fviz_screeplot(res.mca_ConvexityFUM, addlabels = TRUE, ylim = c(0, 45)) 
#contribution to Dim 1 and Dim 2
fviz_contrib(res.mca_ConvexityFUM, choice = "var", axes = 1, top = 15) #contribution to Dim 1. 
fviz_contrib(res.mca_ConvexityFUM, choice = "var", axes = 2, top = 15) #contribution to Dim 2. 

#check and visualise association of variables to Dim 1
cos2_values_dim1 <- res.mca_ConvexityFUM$var$cos2[, 1]

threshold_percentile <- quantile(cos2_values_dim1, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_ConvexityFUM, choice = "var", axes = 1)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#check and visualise association of variables to Dim 2
cos2_values_dim2 <- res.mca_ConvexityFUM$var$cos2[, 2]
threshold_percentile <- quantile(cos2_values_dim2, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_ConvexityFUM, choice = "var", axes = 2)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#association of supplementary categories
cos2_values_supdim1 <- res.mca_ConvexityFUM$quali.sup$cos2[, 1]

threshold_percentilesup1 <- quantile(cos2_values_supdim1, 0.75)

print(threshold_percentilesup1)

filtered_cos2_supdim1 <- cos2_values_supdim1[cos2_values_supdim1 > threshold_percentilesup1]
print(filtered_cos2_supdim1)

cos2_values_supdim2 <- res.mca_ConvexityFUM$quali.sup$cos2[, 2]

threshold_percentilesup2 <- quantile(cos2_values_supdim2, 0.75)

print(threshold_percentilesup2)

filtered_cos2_supdim2 <- cos2_values_supdim2[cos2_values_supdim2 > threshold_percentilesup2]
print(filtered_cos2_supdim2)


```
###correlation
```{r}
library(factoextra)

coord_varFUM3 <- as.data.frame(res.mca_ConvexityFUM$var$coord[, 1:2])

coord_supFUM3 <- as.data.frame(res.mca_ConvexityFUM$quali.sup$coord[, 1:2])

# Subset only rows where the categories are "Blade" or "Bladelet"
coord_supFUM3.2 <- coord_supFUM3 %>% filter(!row.names(coord_supFUM3) %in% c("Blade", "Bladelet")) 


coord_combinedFUM3 <- rbind(coord_varFUM3, coord_supFUM3)
coord_combinedFUM3.2 <-rbind(coord_varFUM3, coord_supFUM3.2)

# Calculate distFUMce matrix FUMd visualize using VAT
data.corFUM7 <- get_dist(coord_varFUM3, method = "euclidean")
print(data.corFUM7)
data.corFUM7_df <- as.data.frame(as.matrix(data.corFUM7))
write_xlsx(data.corFUM7_df, "CorrelationAttributesConvexityFUM1.xlsx")


#heatmap
corConvFUM1 <- fviz_dist(dist.obj = data.corFUM7, 
                     order = TRUE, 
                     show_labels = TRUE)
corConvFUM1

ggsave("CORRConvexityFUM.tiff", plot = corConvFUM1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityFUM.png", plot = corConvFUM1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)   

data.corFUM8 <- get_dist(coord_combinedFUM3.2, method = "euclidean")
data.corFUM8_df <- as.data.frame(as.matrix(data.corFUM8))
write_xlsx(data.corFUM8_df, "CorrelationAttributesConvexityFUM2.xlsx")

#heatmap
corConvFUM2 <- fviz_dist(dist.obj = data.corFUM8, 
                     order = TRUE, 
                     show_labels = TRUE)
corConvFUM2

ggsave("CORRConvexityFUM_withquali.tiff", plot = corConvFUM2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityLL_withquali.png", plot = corConvFUM2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
```
##CTS
```{r}
library(FactoMineR)
library(factoextra)
library(dplyr)
library(ggplot2)



# Select relevant columns and remove missing values
convexity_maintenanceCTS <- Blanks_Main_merged_MCA %>%
  filter(Blank.type1 != "Flake") %>% #check only laminar
  filter(!Axiality %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Symmetry %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Outline.morphology %in% c("NA", "ND", "Other")) %>% #removing blanks without clear info
  filter(!Profile %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Cross.section %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Torsion %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Distal.end.morpho %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(Site == "CTS04inf") %>% #only Ansab
  select(SiteBlank.type2, Axiality, Outline.morphology, Symmetry, Cross.section, Profile, Torsion, Distal.end.morpho) %>%
  na.omit()

summary(convexity_maintenanceCTS)
# Run MCA
res.mca_ConvexityCTS <- MCA(convexity_maintenanceCTS, graph = FALSE, quali.sup =1, method = "Burt") # SiteBlank.type1 is not part of the active variables used to compute the MCA but is considered as supplementary information. The MCA analysis is performed based on the active variables in convexity_maintenanceCTS, and the supplementary variables are used to provide additional information or context to the analysis. Their coordinates are predicted using only the information provided by the performed multiple correspondence analysis on active variables/individuals.

MCA_ConvexityCTS_plot <- fviz_mca_var(
  res.mca_ConvexityCTS,
  col.var = "contrib",
  label = "all",
  invisible = "none",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  max.overlaps=Inf,
  ggtheme = theme_classic()
)
MCA_ConvexityCTS_plot


ggsave("MCAConvexityCTS.tiff", plot = MCA_ConvexityCTS_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("MCAConvexityCTS.png", plot = MCA_ConvexityCTS_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)   

#variance explained by each Dimension
res.mca_ConvexityCTS$eig
fviz_screeplot(res.mca_ConvexityCTS, addlabels = TRUE, ylim = c(0, 45)) 
#contribution to Dim 1 and Dim 2
fviz_contrib(res.mca_ConvexityCTS, choice = "var", axes = 1, top = 15) #contribution to Dim 1. above the threshold are No, Other, Punctiform 

fviz_contrib(res.mca_ConvexityCTS, choice = "var", axes = 2, top = 15) #contribution to Dim 2. above the threshold is only Plain, Punctiform, Linear

#check and visualise association of variables to Dim 1
cos2_values_dim1 <- res.mca_ConvexityCTS$var$cos2[, 1]

threshold_percentile <- quantile(cos2_values_dim1, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_ConvexityCTS, choice = "var", axes = 1)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#check and visualise association of variables to Dim 2
cos2_values_dim2 <- res.mca_ConvexityCTS$var$cos2[, 2]
threshold_percentile <- quantile(cos2_values_dim2, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_ConvexityCTS, choice = "var", axes = 2)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#association of supplementary categories
cos2_values_supdim1 <- res.mca_ConvexityCTS$quali.sup$cos2[, 1]

threshold_percentilesup1 <- quantile(cos2_values_supdim1, 0.75)

print(threshold_percentilesup1)

filtered_cos2_supdim1 <- cos2_values_supdim1[cos2_values_supdim1 > threshold_percentilesup1]
print(filtered_cos2_supdim1)

cos2_values_supdim2 <- res.mca_ConvexityCTS$quali.sup$cos2[, 2]

threshold_percentilesup2 <- quantile(cos2_values_supdim2, 0.75)

print(threshold_percentilesup2)

filtered_cos2_supdim2 <- cos2_values_supdim2[cos2_values_supdim2 > threshold_percentilesup2]
print(filtered_cos2_supdim2)


```
###correlation
```{r}
library(factoextra)

coord_varCTS3 <- as.data.frame(res.mca_ConvexityCTS$var$coord[, 1:2])

coord_supCTS3 <- as.data.frame(res.mca_ConvexityCTS$quali.sup$coord[, 1:2])


coord_combinedCTS3 <- rbind(coord_varCTS3, coord_supCTS3)



# Calculate distance matrix and visualize using VAT
data.corCTS7 <- get_dist(coord_varCTS3, method = "euclidean")
print(data.corCTS7)
data.corCTS7_df <- as.data.frame(as.matrix(data.corCTS7))
write_xlsx(data.corCTS7_df, "CorrelationAttributesConvexityCTS1.xlsx")


#heatmap
corConvCTS1 <- fviz_dist(dist.obj = data.corCTS7, 
                     order = TRUE, 
                     show_labels = TRUE)
corConvCTS1

ggsave("CORRConvexityCTS.tiff", plot = corConvCTS1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityCTS.png", plot = corConvCTS1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)   

data.corCTS8 <- get_dist(coord_combinedCTS3, method = "euclidean")
print(data.corCTS8)
data.corCTS8_df <- as.data.frame(as.matrix(data.corCTS8))
write_xlsx(data.corCTS8_df, "CorrelationAttributesConvexityCTS2.xlsx")

#heatmap
corConvCTS2 <- fviz_dist(dist.obj = data.corCTS8, 
                     order = TRUE, 
                     show_labels = TRUE)
corConvCTS2

ggsave("CORRConvexityCTS_withquali.tiff", plot = corConvCTS2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityCTS_withquali.png", plot = corConvCTS2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
```
##ALL SITES

```{r}
library(FactoMineR)
library(factoextra)
library(dplyr)
library(ggplot2)



# Select relevant columns and remove missing values
convexity_maintenance_ALL2 <- Blanks_Main_merged_MCA %>%
  filter(Blank.type1 != "Flake") %>% #check only laminar
  filter(!Axiality %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Symmetry %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Outline.morphology %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Profile %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Cross.section %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Torsion %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Distal.end.morpho %in% c("NA", "ND")) %>% #removing blanks without clear info
  select(SiteBlank.type2, Blank.type2, Axiality, Outline.morphology, Symmetry, Cross.section, Profile, Torsion, Distal.end.morpho) %>%
  na.omit()
  
summary(convexity_maintenance_ALL2)

# Run MCA
res.mca_convexityALL2 <- MCA(convexity_maintenance_ALL2, graph = FALSE, quali.sup =1:2, method = "Burt") # SiteBlank.type1 is not part of the active variables used to compute the MCA but is considered as supplementary information. The MCA analysis is performed based on the active variables in retouching_ALL2, and the supplementary variables are used to provide additional information or context to the analysis. Their coordinates are predicted using only the information provided by the performed multiple correspondence analysis on active variables/individuals.

MCA_convexityALL2_plot <- fviz_mca_var(
  res.mca_convexityALL2,
  col.var = "contrib",
  label = "all",
  invisible = "none",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  max.overlaps=Inf,
  ggtheme = theme_classic()
)
MCA_convexityALL2_plot


ggsave("MCAconvexityALL.tiff", plot = MCA_convexityALL2_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("MCAconvexityALL.png", plot = MCA_convexityALL2_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300) 

#variance explained by each Dimension
res.mca_convexityALL2$eig
fviz_screeplot(res.mca_convexityALL2, addlabels = TRUE, ylim = c(0, 45))

#contribution to Dim 1 and Dim 2
fviz_contrib(res.mca_convexityALL2, choice = "var", axes = 1, top = 15) #contribution to Dim 1. 
fviz_contrib(res.mca_convexityALL2, choice = "var", axes = 2, top = 15) #contribution to Dim 2. 

#check and visualise association of variables to Dim 1
cos2_values_dim1 <- res.mca_convexityALL2$var$cos2[, 1]

threshold_percentile <- quantile(cos2_values_dim1, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_convexityALL2, choice = "var", axes = 1)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#check and visualise association of variables to Dim 2
cos2_values_dim2 <- res.mca_convexityALL2$var$cos2[, 2]
threshold_percentile <- quantile(cos2_values_dim2, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_convexityALL2, choice = "var", axes = 2)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#association of supplementary categories
cos2_values_supdim1 <- res.mca_convexityALL2$quali.sup$cos2[, 1]

threshold_percentilesup1 <- quantile(cos2_values_supdim1, 0.75)

print(threshold_percentilesup1)

filtered_cos2_supdim1 <- cos2_values_supdim1[cos2_values_supdim1 > threshold_percentilesup1]
print(filtered_cos2_supdim1)

cos2_values_supdim2 <- res.mca_convexityALL2$quali.sup$cos2[, 2]

threshold_percentilesup2 <- quantile(cos2_values_supdim2, 0.75)

print(threshold_percentilesup2)

filtered_cos2_supdim2 <- cos2_values_supdim2[cos2_values_supdim2 > threshold_percentilesup2]
print(filtered_cos2_supdim2)
   
```
###correlation
```{r}
library(factoextra)

coord_var3 <- as.data.frame(res.mca_convexityALL2$var$coord[, 1:2])

coord_sup3 <- as.data.frame(res.mca_convexityALL2$quali.sup$coord[, 1:2])

# Subset only rows where the categories are "Blade" or "Bladelet"
coord_sup3.2 <- coord_sup3 %>% filter(row.names(coord_sup3) %in% c("Blade", "Bladelet")) 
coord_sup3.3 <- coord_sup3 %>% filter(!(row.names(coord_sup3) %in% c("Blade", "Bladelet")))


coord_combined3 <- rbind(coord_var3, coord_sup3)
coord_combined3.2 <-rbind(coord_var3, coord_sup3.2)
coord_combined3.3 <-rbind(coord_var3, coord_sup3.3)

# Calculate distance matrix and visualize using VAT
data.cor7 <- get_dist(coord_var3, method = "euclidean")
print(data.cor7)
data.cor7_df <- as.data.frame(as.matrix(data.cor7))
write_xlsx(data.cor7_df, "CorrelationAttributesConvexity1.xlsx")

#heatmap
corConv1 <- fviz_dist(dist.obj = data.cor7, 
                     order = TRUE, 
                     show_labels = TRUE)
corConv1

ggsave("CORRConvexityALL.tiff", plot = corConv1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityALL.png", plot = corConv1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)   

data.cor8 <- get_dist(coord_combined3.2, method = "euclidean")
data.cor8_df <- as.data.frame(as.matrix(data.cor8))
write_xlsx(data.cor8_df, "CorrelationAttributesConvexity2.xlsx")

#heatmap
corConv2 <- fviz_dist(dist.obj = data.cor8, 
                     order = TRUE, 
                     show_labels = TRUE)
corConv2

ggsave("CORRConvexityALL_withquali.tiff", plot = corConv2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityALL_withquali.png", plot = corConv2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)

data.cor9 <- get_dist(coord_combined3.3, method = "euclidean")
data.cor9_df <- as.data.frame(as.matrix(data.cor9))
write_xlsx(data.cor9_df, "CorrelationAttributesConvexity3.xlsx")

#heatmap
corConv3 <- fviz_dist(
  dist.obj = data.cor9,
  order = TRUE,
  show_labels = TRUE)
corConv3

ggsave("CORRConvexityALL_withquali_2.tiff", plot = corConv3, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityALL_withquali_2.png", plot = corConv3, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
```


##CONTROL
```{r}
library(FactoMineR)
library(factoextra)
library(dplyr)
library(ggplot2)



# Select relevant columns and remove missing values
convexity_maintenance_CONTROL <- combinedControl_MCA %>%
  filter(Blank.type1 != "Flake") %>% #check only laminar
  filter(!Axiality %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Outline.morphology %in% c("NA", "ND", "Divergent", "Biconvex")) %>% #removing blanks without clear info
  filter(!Profile %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Cross.section %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Torsion %in% c("NA", "ND")) %>% #removing blanks without clear info
  filter(!Distal.end.morpho %in% c("NA", "ND")) %>% #removing blanks without clear info
  select(Technocomplex, SiteBlank.type2,Axiality, Outline.morphology, Cross.section, Profile, Torsion, Distal.end.morpho) %>%
  na.omit()
  
summary(convexity_maintenance_CONTROL)

# Run MCA
res.mca_convexityCONTROL<- MCA(convexity_maintenance_CONTROL, graph = FALSE, quali.sup =1:2, method = "Burt") # SiteBlank.type1 is not part of the active variables used to compute the MCA but is considered as supplementary information. The MCA analysis is performed based on the active variables in retouching_ALL2, and the supplementary variables are used to provide additional information or context to the analysis. Their coordinates are predicted using only the information provided by the performed multiple correspondence analysis on active variables/individuals.

MCA_convexitycontrol_plot <- fviz_mca_var(
  res.mca_convexityCONTROL,
  col.var = "contrib",
  label = "all",
  invisible = "none",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  max.overlaps=Inf,
  ggtheme = theme_classic()
)
MCA_convexitycontrol_plot


ggsave("MCAconvexityCONTROL.tiff", plot = MCA_convexitycontrol_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("MCAconvexityCONTROL.png", plot = MCA_convexitycontrol_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300) 

#variance explained by each Dimension
res.mca_convexityCONTROL$eig
fviz_screeplot(res.mca_convexityCONTROL, addlabels = TRUE, ylim = c(0, 45)) 
#contribution to Dim 1 and Dim 2
fviz_contrib(res.mca_convexityCONTROL, choice = "var", axes = 1, top = 15) 

fviz_contrib(res.mca_convexityCONTROL, choice = "var", axes = 2, top = 15) 

#check and visualise association of variables to Dim 1
cos2_values_dim1 <- res.mca_convexityCONTROL$var$cos2[, 1]

threshold_percentile <- quantile(cos2_values_dim1, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_convexityCONTROL, choice = "var", axes = 1)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#check and visualise association of variables to Dim 2
cos2_values_dim2 <- res.mca_convexityCONTROL$var$cos2[, 2]
threshold_percentile <- quantile(cos2_values_dim2, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_convexityCONTROL, choice = "var", axes = 2)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#association of supplementary categories
cos2_values_supdim1 <- res.mca_convexityCONTROL$quali.sup$cos2[, 1]

threshold_percentilesup1 <- quantile(cos2_values_supdim1, 0.75)

print(threshold_percentilesup1)

filtered_cos2_supdim1 <- cos2_values_supdim1[cos2_values_supdim1 > threshold_percentilesup1]
print(filtered_cos2_supdim1)

cos2_values_supdim2 <- res.mca_convexityCONTROL$quali.sup$cos2[, 2]

threshold_percentilesup2 <- quantile(cos2_values_supdim2, 0.75)

print(threshold_percentilesup2)

filtered_cos2_supdim2 <- cos2_values_supdim2[cos2_values_supdim2 > threshold_percentilesup2]
print(filtered_cos2_supdim2)



 
```
###correlation
```{r}
library(factoextra)

coord_var4 <- as.data.frame(res.mca_convexityCONTROL$var$coord[, 1:2])

coord_sup4 <- as.data.frame(res.mca_convexityCONTROL$quali.sup$coord[, 1:2])

# Combine both for distance calculation
coord_sup4.2 <- coord_sup4 %>% filter(row.names(coord_sup4) %in% c("Proto", "S.Ahm", "Solu")) 
coord_sup4.3 <- coord_sup4 %>% filter(!(row.names(coord_sup4) %in% c("Proto", "S.Ahm", "Solu")))


coord_combined4 <- rbind(coord_var4, coord_sup4)
coord_combined4.2 <-rbind(coord_var4, coord_sup4.2)
coord_combined4.3 <-rbind(coord_var4, coord_sup4.3)


# Calculate the distance matrix using euclidean correlation distance
data.cor10 <- get_dist(coord_var4, method = "euclidean")
data.cor10_df <- as.data.frame(as.matrix(data.cor10))
write_xlsx(data.cor10_df, "CorrelationAttributesConvexityCONTROL1.xlsx")

#heatmap
corConv4 <- fviz_dist(dist.obj = data.cor10, 
                     order = TRUE, 
                     show_labels = TRUE)
corConv4

ggsave("CORRConvexityCONTROL.tiff", plot = corConv4, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityCONTROL.png", plot = corConv4, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)

data.cor11 <- get_dist(coord_combined4.2, method = "euclidean")
data.cor11_df <- as.data.frame(as.matrix(data.cor11))
write_xlsx(data.cor11_df, "CorrelationAttributesConvexityCONTROL2.xlsx")


#heatmap
corConv5 <- fviz_dist(dist.obj = data.cor11, 
                     order = TRUE, 
                     show_labels = TRUE)
corConv5


ggsave("CORRConvexityCONTROL_withquali.tiff", plot = corConv5, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityCONTROL_withquali.png", plot = corConv5, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)

data.cor12 <- get_dist(coord_combined4.3, method = "euclidean")
data.cor12_df <- as.data.frame(as.matrix(data.cor12))
write_xlsx(data.cor12_df, "CorrelationAttributesConvexityCONTROL3.xlsx")

#heatmap
corConv6 <- fviz_dist(dist.obj = data.cor12, 
                     order = TRUE, 
                     show_labels = TRUE)
corConv6


ggsave("CORRConvexityCONTROL_withquali_2.tiff", plot = corConv6, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRConvexityCONTROL_withquali_2.png", plot = corConv6, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)

```

#Retouching
##ALL SITES

```{r}
library(FactoMineR)
library(factoextra)
library(dplyr)
library(ggplot2)



# Select relevant columns and remove missing values
retouching_ALL2 <- Blanks_Main_merged_MCA %>% 
  filter(Blank.type1 != "Flake", Tool == "Yes", Typology %in% c("Blade retouched", "Bladelet retouched", "Bladelet with lateral retouch", "Blade with lateral retouch", "Dufour bladelet", "Font-Yves point", "Blade Aurignacian", "Blade pointed", "Backed bladelet", "Backed blade", "El-Wad point")  ) %>% 
  filter(!Retouch.Location %in% c("NA", "ND"))%>%
filter(!Retouch.Distribution %in% c("NA", "ND"))%>%
  select(SiteBlank.type2, Retouch.Position, Retouch.Location, Retouch.Distribution) %>%
  na.omit()
  
summary(retouching_ALL2)

# Run MCA
res.mca_retouchingALL2 <- MCA(retouching_ALL2, graph = FALSE, quali.sup =1, method = "Burt") # SiteBlank.type1 is not part of the active variables used to compute the MCA but is considered as supplementary information. The MCA analysis is performed based on the active variables in retouching_ALL2, and the supplementary variables are used to provide additional information or context to the analysis. Their coordinates are predicted using only the information provided by the performed multiple correspondence analysis on active variables/individuals.

MCA_retouchingALL2_plot <- fviz_mca_var(
  res.mca_retouchingALL2,
  col.var = "contrib",
  label = "all",
  invisible = "none",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
  repel = TRUE,
  max.overlaps=Inf,
  ggtheme = theme_classic()
)
MCA_retouchingALL2_plot

ggsave("MCAretouchingALL.tiff", plot = MCA_retouchingALL2_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("MCAretouchingALL.png", plot = MCA_retouchingALL2_plot, width = 43.656255, height = 20.29354, units = "cm", dpi = 300) 

#variance explained by each Dimension
res.mca_retouchingALL2$eig
fviz_screeplot(res.mca_retouchingALL2, addlabels = TRUE, ylim = c(0, 45)) 
#contribution to Dim 1 and Dim 2
fviz_contrib(res.mca_retouchingALL2, choice = "var", axes = 1, top = 15) #contribution to Dim 1. above the threshold are No, Other, Punctiform 

fviz_contrib(res.mca_retouchingALL2, choice = "var", axes = 2, top = 15) #contribution to Dim 2. above the threshold is only Plain, Punctiform, Linear

#check and visualise association of variables to Dim 1
cos2_values_dim1 <- res.mca_retouchingALL2$var$cos2[, 1]

threshold_percentile <- quantile(cos2_values_dim1, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_retouchingALL2, choice = "var", axes = 1)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#check and visualise association of variables to Dim 2
cos2_values_dim2 <- res.mca_retouchingALL2$var$cos2[, 2]
threshold_percentile <- quantile(cos2_values_dim2, 0.75)

print(threshold_percentile)

plot <- fviz_cos2(res.mca_retouchingALL2, choice = "var", axes = 2)

plot + geom_hline(yintercept = threshold_percentile, linetype = "dashed", color = "red")

#association of supplementary categories
cos2_values_supdim1 <- res.mca_retouchingALL2$quali.sup$cos2[, 1]

threshold_percentilesup1 <- quantile(cos2_values_supdim1, 0.75)

print(threshold_percentilesup1)

filtered_cos2_supdim1 <- cos2_values_supdim1[cos2_values_supdim1 > threshold_percentilesup1]
print(filtered_cos2_supdim1)

cos2_values_supdim2 <- res.mca_retouchingALL2$quali.sup$cos2[, 2]

threshold_percentilesup2 <- quantile(cos2_values_supdim2, 0.75)

print(threshold_percentilesup2)

filtered_cos2_supdim2 <- cos2_values_supdim2[cos2_values_supdim2 > threshold_percentilesup2]
print(filtered_cos2_supdim2)



   
```
###correlation
```{r}
library(factoextra)

coord_var5 <- as.data.frame(res.mca_retouchingALL2$var$coord[, 1:2])

coord_sup5 <- as.data.frame(res.mca_retouchingALL2$quali.sup$coord[, 1:2])


coord_combined5 <- rbind(coord_var5, coord_sup5)


# Calculate distance matrix and visualize using VAT
data.cor13 <- get_dist(coord_var5, method = "euclidean")
print(data.cor13)
data.cor13_df <- as.data.frame(as.matrix(data.cor13))
write_xlsx(data.cor13_df, "CorrelationAttributesretouching1.xlsx")


#heatmap
corret1 <- fviz_dist(dist.obj = data.cor13, 
                     order = TRUE, 
                     show_labels = TRUE)
corret1

ggsave("CORRretouchingALL.tiff", plot = corret1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRretouchingALL.png", plot = corret1, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)   

data.cor14 <- get_dist(coord_combined5, method = "euclidean")
data.cor14_df <- as.data.frame(as.matrix(data.cor14))
write_xlsx(data.cor14_df, "CorrelationAttributesretouching2.xlsx")



#heatmap
corret2 <- fviz_dist(dist.obj = data.cor14, 
                     order = TRUE, 
                     show_labels = TRUE)
corret2

ggsave("CORRretouchingALL_withquali.tiff", plot = corret2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)
ggsave("CORRretouchingLL_withquali.png", plot = corret2, width = 43.656255, height = 20.29354, units = "cm", dpi = 300)


```

